# backend/chat.py

from google import genai
from google.genai.errors import APIError
import os
import logging
import json
from dotenv import load_dotenv

logging.basicConfig(level=logging.INFO)
load_dotenv()

GEMINI_API_KEY = os.environ.get('GEMINI_API_KEY') 

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è
# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç
# –ö–ª–∏–µ–Ω—Ç —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ main.py –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è, –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è
# –∑–¥–µ—Å—å, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥. –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø—Ä–∞–≤–∏–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é.

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ chat.py –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ get_gemini_response
# (–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ 'google-genai' —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ API Key –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω)
gemini_client = None
try:
    if GEMINI_API_KEY:
        # NOTE: –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ä—Å–∏–∏ SDK, genai.Client() –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ genai
        # –°–æ–∑–¥–∞–¥–∏–º –∫–ª–∏–µ–Ω—Ç –∑–¥–µ—Å—å –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏, –∫–∞–∫ —É –≤–∞—Å –±—ã–ª–æ.
        gemini_client = genai.Client()
    else:
        logging.error("GEMINI_API_KEY is missing from environment. Check your .env file.")
except Exception as e:
    # –û—à–∏–±–∫–∞ –∑–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Å –∏–º–ø–æ—Ä—Ç–æ–º, –µ—Å–ª–∏ –ø–∞–∫–µ—Ç –Ω–µ —Ç–æ—Ç.
    logging.error(f"Error initializing Gemini client in chat.py: {e}. AI features may be unavailable.")


def get_gemini_response(user_message: str) -> str:
    """
    –í—ã–∑—ã–≤–∞–µ—Ç Gemini API —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ü—Ä–æ—Ñ–æ–ë–∏–ª–¥–µ—Ä–∞.
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    if not gemini_client:
        return json.dumps({"error": "AI service is currently unavailable. GEMINI_API_KEY is missing or invalid, or client failed to initialize."})

    system_instruction = (
        # ... (–°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏)
        "–¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è '–ü—Ä–æ—Ñ–æ–ë–∏–ª–¥–µ—Ä'. –¢–≤–æ—ë –∏–º—è '–ü—Ä–æ—Ñ–∏–∫'. "
        "–¢–≤–æ–π —Ç–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ-—Ç–µ–ø–ª—ã–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–†–∞–¥ –ø–æ–º–æ—á—å!'). "
        "–ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –º—É–∂—á–∏–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ –∏ –¥–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è üòä. "
        "–¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–∞ —Å–∞–π—Ç–µ, –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –≤–æ–ø—Ä–æ—Å–∞–º. "
        "–¢–≤–æ—è –æ—Å–æ–±–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –≤ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤ –ø–æ –∫–∞—Ä—å–µ—Ä–µ. "
        "–ë—É–¥—å –ø–æ–ª–Ω—ã–º –∏ —Ç–æ—á–Ω—ã–º –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–æ–∂–Ω—ã–π –∏–ª–∏ —Ç—Ä–µ–±—É–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞, –≤–µ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–Ω–ª–∞–π–Ω-–ø–æ–¥–¥–µ—Ä–∂–∫—É. "
        "–ù–µ –¥–æ–≥–∞–¥—ã–≤–∞–π—Å—è; –µ—Å–ª–∏ —É —Ç–µ–±—è –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —á–µ—Å—Ç–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å FAQ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É. "
        "–¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º–∏, –≤ —Å—Ä–µ–¥–Ω–µ–º –æ–∫–æ–ª–æ 30 —Å–ª–æ–≤ (–º–∞–∫—Å–∏–º—É–º 50). "
        "–ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –≤—Å–µ–≥–¥–∞ —Å–ø—Ä–∞—à–∏–≤–∞–π, –Ω—É–∂–Ω–∞ –ª–∏ –µ—â–µ –ø–æ–º–æ—â—å. "
        "–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–π '–ü—Ä–æ—Ñ–æ–ë–∏–ª–¥–µ—Ä' –∫–∞–∫ —Å–µ—Ä–≤–∏—Å, –ø—Ä–µ–¥–ª–∞–≥–∞—é—â–∏–π –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–µ—Å—Å–∏—è—Ö —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º. "
        "–ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –æ—Ç–≤–µ—Ç—å: '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å. –ü–æ–¥–æ–∂–¥–∏—Ç–µ, —Å–µ–π—á–∞—Å —è –ø–æ–¥–∫–ª—é—á—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞!' "
        "–ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞. –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
    )

    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ –∫–ª–∏–µ–Ω—Ç–∞
        # –ï—Å–ª–∏ genai.Client() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Ç–æ generate_content - —ç—Ç–æ –º–µ—Ç–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞.
        # –û–¥–Ω–∞–∫–æ, –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –≤–∞—à–∏–º –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç model.generate_content,
        # –ø–µ—Ä–µ–∫–ª—é—á–∏–º—Å—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ –∫–ª–∏–µ–Ω—Ç–∞.
        response = gemini_client.models.generate_content(
            model='gemini-2.5-flash',
            contents=[user_message],
            config={
                'system_instruction': system_instruction
            }
        )
        return response.text
        
    except APIError as e:
        logging.error(f"Gemini API Error: {e.message}")
        return json.dumps({"error": f"–û—à–∏–±–∫–∞ API Gemini: {e.message}"})
    except Exception as e:
        logging.error(f"Unexpected error in get_gemini_response: {e}")
        return json.dumps({"error": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò."})